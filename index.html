<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ­ãƒ¼ãƒ³æ¯”è¼ƒ & æ§é™¤ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ Pro v4.1</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #0f172a; --secondary: #64748b; --accent: #2563eb;
            --bg: #f1f5f9; --white: #ffffff;
            --color-ganri: #3b82f6; --color-gankin: #8b5cf6;
            --color-interest: #f43f5e; --color-tax: #16a34a;
        }
        body { font-family: -apple-system, sans-serif; color: #1e293b; background-color: var(--bg); margin: 0; padding: 10px; }
        .container { max-width: 1400px; margin: 0 auto; }
        .card { background: var(--white); padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; }
        
        /* å…¥åŠ›ã‚¨ãƒªã‚¢ */
        .input-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; }
        label { display: block; font-size: 0.7rem; font-weight: 700; margin-bottom: 4px; color: #475569; }
        input { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 14px; box-sizing: border-box; }
        .btn-calc { width: 100%; padding: 16px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: bold; margin: 15px 0; }

        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ»æ¯”è¼ƒãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆä¿®æ­£ */
        .comparison-layout { 
            display: flex; 
            flex-direction: row; /* åŸºæœ¬ã¯æ¨ªä¸¦ã³ */
            gap: 15px; 
            align-items: flex-start;
        }
        .column { 
            flex: 1; /* ä¸¡æ–¹ã®ã‚«ãƒ©ãƒ ã‚’åŒã˜å¹…ã§åºƒã’ã‚‹ */
            min-width: 0; /* flexã‚¢ã‚¤ãƒ†ãƒ ãŒä¸­èº«ã«åˆã‚ã›ã¦çªãæŠœã‘ã‚‹ã®ã‚’é˜²ã */
        }

        /* ã‚¹ãƒãƒ›å¯¾å¿œï¼š768pxä»¥ä¸‹ã§ç¸¦ä¸¦ã³ */
        @media (max-width: 768px) {
            .comparison-layout { flex-direction: column; }
            .column { width: 100%; }
        }

        /* ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ */
        details { background: var(--white); border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 15px; overflow: hidden; }
        summary { padding: 12px 15px; font-weight: bold; cursor: pointer; background: #f8fafc; border-bottom: 1px solid #e2e8f0; list-style: none; display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem; }
        summary::after { content: 'â–¼'; font-size: 0.7rem; color: var(--secondary); }
        details[open] summary::after { content: 'â–²'; }
        .details-content { padding: 15px; }

        /* ã‚µãƒãƒªãƒ¼ãƒ»çµ±è¨ˆ */
        .summary-box { padding: 12px; border-radius: 10px; border: 1px solid #e2e8f0; background: #fff; margin-bottom: 0; }
        .summary-box.ganri { border-left: 6px solid var(--color-ganri); }
        .summary-box.gankin { border-left: 6px solid var(--color-gankin); }
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 0.85rem; }
        .stat-total { font-size: 1rem; color: var(--accent); border-top: 1px solid #eee; margin-top: 8px; padding-top: 8px; font-weight: bold; }

        .chart-container { height: 280px; margin-bottom: 10px; }
        
        /* ãƒ†ãƒ¼ãƒ–ãƒ«ä¿®æ­£ï¼šå¹…ãŒç‹­ãã¦ã‚‚å´©ã‚Œãªã„ã‚ˆã†ã« */
        .table-wrapper { overflow-x: auto; max-height: 400px; border: 1px solid #e2e8f0; border-radius: 8px; }
        table { width: 100%; border-collapse: collapse; font-size: 0.7rem; white-space: nowrap; }
        th, td { padding: 6px 8px; text-align: right; border-bottom: 1px solid #f1f5f9; }
        th { background: #f8fafc; position: sticky; top: 0; z-index: 10; }
        .sticky-col { position: sticky; left: 0; background: #f8fafc; font-weight: bold; text-align: left; }

        .main-title { text-align: center; margin-bottom: 20px; font-size: 1.5rem; }
        .col-title { font-size: 1.1rem; font-weight: bold; text-align: center; margin-bottom: 12px; padding: 10px; border-radius: 8px; color: white; }
    </style>
</head>
<body>

<div class="container">
    <h1 class="main-title">ğŸ¦ ãƒ­ãƒ¼ãƒ³æ¯”è¼ƒ & æ§é™¤ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ Pro</h1>

    <div class="card">
        <div class="input-grid">
            <div class="field"><label>å€Ÿå…¥é‡‘é¡ (ä¸‡å††)</label><input type="number" id="loan_amount" value="3000"></div>
            <div class="field"><label>é‡‘åˆ© (%)</label><input type="number" id="interest_rate" value="1.0" step="0.1"></div>
            <div class="field"><label>æœŸé–“ (å¹´)</label><input type="number" id="loan_term" value="35"></div>
            <div class="field"><label>æ§é™¤é™åº¦é¡ (ä¸‡å††)</label><input type="number" id="tax_limit" value="3000"></div>
            <div class="field"><label>æ§é™¤æœŸé–“ (å¹´)</label><input type="number" id="tax_years" value="13"></div>
            <div class="field"><label>æ§é™¤ç‡ (%)</label><input type="number" id="tax_rate" value="0.7" step="0.1"></div>
        </div>
        <button class="btn-calc" onclick="App.run()">æ¯”è¼ƒã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œ</button>
    </div>

    <div id="result_area" style="display:none;">
        
        <div class="card" style="background: #f8fafc; padding: 15px;">
            <h3 style="margin: 0 0 15px 0; text-align:center; font-size: 1rem;">æœˆã€…ã®æ”¯æ‰•é¡ æ¨ç§»æ¯”è¼ƒ (æŠ˜ã‚Œç·š)</h3>
            <div style="height:250px;"><canvas id="chart_monthly_combined"></canvas></div>
        </div>

        <div class="comparison-layout">
            <div class="column" id="col_ganri">
                <div class="col-title" style="background: var(--color-ganri);">å…ƒåˆ©å‡ç­‰</div>
                
                <details open>
                    <summary>1. è¿”æ¸ˆã‚µãƒãƒªãƒ¼</summary>
                    <div class="details-content" id="summary_ganri"></div>
                </details>

                <details open>
                    <summary>2. å¹´é–“ã‚³ã‚¹ãƒˆæ¨ç§»</summary>
                    <div class="details-content">
                        <div class="chart-container"><canvas id="chart_ganri_bar"></canvas></div>
                    </div>
                </details>

                <details open>
                    <summary>3. è¿”æ¸ˆæ˜ç´°</summary>
                    <div class="details-content">
                        <div class="table-wrapper">
                            <table id="table_ganri">
                                <thead>
                                    <tr><th class="sticky-col">çµŒéå¹´</th><th>æœˆæ”¯æ‰•</th><th>å¹´æ”¯æ‰•</th><th>å¹´æ§é™¤</th><th>å¹´æ®‹å‚µ</th></tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </details>
            </div>

            <div class="column" id="col_gankin">
                <div class="col-title" style="background: var(--color-gankin);">å…ƒé‡‘å‡ç­‰</div>

                <details open>
                    <summary>1. è¿”æ¸ˆã‚µãƒãƒªãƒ¼</summary>
                    <div class="details-content" id="summary_gankin"></div>
                </details>

                <details open>
                    <summary>2. å¹´é–“ã‚³ã‚¹ãƒˆæ¨ç§»</summary>
                    <div class="details-content">
                        <div class="chart-container"><canvas id="chart_gankin_bar"></canvas></div>
                    </div>
                </details>

                <details open>
                    <summary>3. è¿”æ¸ˆæ˜ç´°</summary>
                    <div class="details-content">
                        <div class="table-wrapper">
                            <table id="table_gankin">
                                <thead>
                                    <tr><th class="sticky-col">çµŒéå¹´</th><th>æœˆæ”¯æ‰•</th><th>å¹´æ”¯æ‰•</th><th>å¹´æ§é™¤</th><th>å¹´æ®‹å‚µ</th></tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </details>
            </div>
        </div>
    </div>
</div>

<script>
// (JSãƒ­ã‚¸ãƒƒã‚¯ã¯å‰å›åŒæ§˜ã§ã™ãŒã€Scaleçµ±ä¸€ãªã©ã®å‡¦ç†ã‚’ç¶­æŒã—ã¦ã„ã¾ã™)
const App = {
    charts: {},

    run() {
        const config = {
            P: parseFloat(document.getElementById('loan_amount').value) * 10000,
            r: (parseFloat(document.getElementById('interest_rate').value) / 100) / 12,
            n: parseInt(document.getElementById('loan_term').value) * 12,
            tLim: parseFloat(document.getElementById('tax_limit').value) * 10000,
            tY: parseInt(document.getElementById('tax_years').value),
            tRate: parseFloat(document.getElementById('tax_rate').value) / 100
        };

        const resGanri = this.calc(config, 'ganri');
        const resGankin = this.calc(config, 'gankin');

        const maxVal = Math.max(
            ...resGanri.history.map(d => d.principal + d.interest),
            ...resGankin.history.map(d => d.principal + d.interest)
        );

        this.renderSummary('summary_ganri', resGanri.summary, 'ganri');
        this.renderSummary('summary_gankin', resGankin.summary, 'gankin');
        this.renderCombinedLineChart(resGanri, resGankin);
        this.renderBarChart('chart_ganri_bar', resGanri, '#3b82f6', maxVal);
        this.renderBarChart('chart_gankin_bar', resGankin, '#8b5cf6', maxVal);
        this.renderTable('table_ganri', resGanri.history);
        this.renderTable('table_gankin', resGankin.history);

        document.getElementById('result_area').style.display = 'block';
    },

    calc(conf, type) {
        let remaining = conf.P;
        let history = [];
        const monthlyGanri = conf.P * conf.r * Math.pow(1 + conf.r, conf.n) / (Math.pow(1 + conf.r, conf.n) - 1);
        const fixedPrincipal = conf.P / conf.n;
        let totalInterest = 0, totalTaxBack = 0;

        for (let y = 1; y <= conf.n / 12; y++) {
            let yP = 0, yI = 0, yT = 0, firstM = 0;
            for (let m = 1; m <= 12; m++) {
                let interest = remaining * conf.r;
                let principal = (type === 'ganri') ? (monthlyGanri - interest) : fixedPrincipal;
                if(m === 1) firstM = principal + interest;
                yP += principal; yI += interest;
                remaining -= principal;
            }
            if (y <= conf.tY) {
                const base = Math.min(Math.max(0, remaining + yP/2), conf.tLim);
                yT = Math.round(base * conf.tRate);
            }
            totalInterest += yI; totalTaxBack += yT;
            history.push({
                year: y, monthly: Math.round(firstM / 10000 * 10) / 10,
                annualPay: Math.round((yP + yI) / 10000), principal: Math.round(yP / 10000),
                interest: Math.round(yI / 10000), taxBack: Math.round(yT / 10000),
                balance: Math.round(Math.max(0, remaining) / 10000)
            });
        }
        return { history, summary: { totalPay: Math.round((conf.P + totalInterest) / 10000), totalInterest: Math.round(totalInterest / 10000), totalTaxBack: Math.round(totalTaxBack / 10000) } };
    },

    renderSummary(id, data, type) {
        document.getElementById(id).innerHTML = `
            <div class="summary-box ${type}">
                <div class="stat-row"><span>ç·æ”¯æ‰•</span><span>${data.totalPay.toLocaleString()}ä¸‡</span></div>
                <div class="stat-row"><span>åˆ©æ¯</span><span style="color:var(--color-interest)">+${data.totalInterest.toLocaleString()}ä¸‡</span></div>
                <div class="stat-row"><span>æ§é™¤</span><span style="color:var(--color-tax)">-${data.totalTaxBack.toLocaleString()}ä¸‡</span></div>
                <div class="stat-row stat-total"><span>å®Ÿè³ª</span><span>${(data.totalPay - data.totalTaxBack).toLocaleString()}ä¸‡</span></div>
            </div>
        `;
    },

    renderCombinedLineChart(ganri, gankin) {
        const ctx = document.getElementById('chart_monthly_combined').getContext('2d');
        if (this.charts['monthly']) this.charts['monthly'].destroy();
        this.charts['monthly'] = new Chart(ctx, {
            type: 'line',
            data: {
                labels: ganri.history.map(d => d.year + 'å¹´'),
                datasets: [
                    { label: 'å…ƒåˆ©', data: ganri.history.map(d => d.monthly), borderColor: '#3b82f6', tension: 0 },
                    { label: 'å…ƒé‡‘', data: gankin.history.map(d => d.monthly), borderColor: '#8b5cf6', tension: 0 }
                ]
            },
            options: { maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
        });
    },

    renderBarChart(id, res, color, maxVal) {
        const ctx = document.getElementById(id).getContext('2d');
        if (this.charts[id]) this.charts[id].destroy();
        this.charts[id] = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: res.history.map(d => d.year + 'å¹´'),
                datasets: [
                    { label: 'å…ƒé‡‘', data: res.history.map(d => d.principal), backgroundColor: color, stacked: true },
                    { label: 'åˆ©æ¯', data: res.history.map(d => d.interest), backgroundColor: '#f43f5e', stacked: true },
                    { label: 'æ§é™¤', data: res.history.map(d => -d.taxBack), backgroundColor: '#16a34a', stacked: true }
                ]
            },
            options: { 
                maintainAspectRatio: false, 
                scales: { y: { stacked: true, max: maxVal + 10 } },
                plugins: { legend: { display: false } }
            }
        });
    },

    renderTable(id, data) {
        document.getElementById(id).querySelector('tbody').innerHTML = data.map(d => `
            <tr>
                <td class="sticky-col">${d.year}å¹´</td>
                <td>${d.monthly}</td>
                <td>${d.annualPay}</td>
                <td style="color:var(--color-tax)">-${d.taxBack}</td>
                <td style="font-weight:bold">${d.balance}</td>
            </tr>
        `).join('');
    }
};

window.onload = () => App.run();
</script>
</body>
</html>

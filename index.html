<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ­ãƒ¼ãƒ³æ¯”è¼ƒ & æ§é™¤ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #0f172a; --secondary: #64748b; --accent: #2563eb;
            --bg: #f1f5f9; --white: #ffffff;
            --color-principal: #3b82f6; --color-interest: #f43f5e; --color-tax: #16a34a;
        }
        body { font-family: -apple-system, sans-serif; color: #1e293b; background-color: var(--bg); margin: 0; padding: 10px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .card { background: var(--white); padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; }
        .field { margin-bottom: 10px; }
        label { display: block; font-size: 0.7rem; font-weight: 700; margin-bottom: 4px; color: #475569; text-transform: uppercase; }
        input, select { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 14px; box-sizing: border-box; outline: none; }
        .section-title { font-size: 1.1rem; font-weight: bold; margin-bottom: 15px; border-left: 4px solid var(--primary); padding-left: 10px; display: flex; justify-content: space-between; }
        
        .chart-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-top: 10px; }
        .chart-container { height: 350px; position: relative; }
        
        .table-wrapper { overflow-x: auto; margin-top: 20px; background: white; border-radius: 8px; border: 1px solid #e2e8f0; }
        table { width: 100%; border-collapse: collapse; font-size: 0.75rem; min-width: 800px; }
        th { background: #f8fafc; padding: 10px; text-align: right; color: var(--secondary); border-bottom: 2px solid #e2e8f0; }
        td { padding: 8px 10px; text-align: right; border-bottom: 1px solid #f1f5f9; }
        .sticky-col { position: sticky; left: 0; background: #f8fafc; font-weight: bold; text-align: left; }
        
        .btn-calc { width: 100%; padding: 16px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: bold; margin-top: 10px; }
        .legend { display: flex; gap: 15px; font-size: 0.8rem; margin-bottom: 10px; justify-content: center; }
        .legend-item { display: flex; align-items: center; gap: 5px; }
        .dot { width: 12px; height: 12px; border-radius: 3px; }
    </style>
</head>
<body>

<div class="container">
    <h1 style="text-align:center">ğŸ¦ ãƒ­ãƒ¼ãƒ³æ¯”è¼ƒ & æ§é™¤ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</h1>

    <div class="card">
        <div class="section-title">ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å…¥åŠ›</div>
        <div class="grid">
            <div class="field"><label>å€Ÿå…¥é‡‘é¡ (ä¸‡å††)</label><input type="number" id="loan_amount" value="4000"></div>
            <div class="field"><label>é‡‘åˆ© (%)</label><input type="number" id="interest_rate" value="0.7" step="0.01"></div>
            <div class="field"><label>æœŸé–“ (å¹´)</label><input type="number" id="loan_term" value="35"></div>
            <div class="field"><label>æ§é™¤é™åº¦é¡ (ä¸‡å††)</label><input type="number" id="tax_limit" value="3000"></div>
            <div class="field"><label>æ§é™¤æœŸé–“ (å¹´)</label><input type="number" id="tax_years" value="13"></div>
            <div class="field"><label>æ§é™¤ç‡ (%)</label><input type="number" id="tax_rate" value="0.7" step="0.1"></div>
        </div>
        <button class="btn-calc" onclick="App.run()">ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã—ã¦æ¯”è¼ƒ</button>
    </div>

    <div id="result_area" style="display:none;">
        <div class="legend">
            <div class="legend-item"><span class="dot" style="background:var(--color-principal)"></span>å…ƒé‡‘</div>
            <div class="legend-item"><span class="dot" style="background:var(--color-interest)"></span>åˆ©æ¯</div>
            <div class="legend-item"><span class="dot" style="background:var(--color-tax)"></span>ãƒ­ãƒ¼ãƒ³æ§é™¤(é‚„ä»˜)</div>
        </div>

        <div class="chart-row">
            <div class="card">
                <div class="section-title">å…ƒåˆ©å‡ç­‰è¿”æ¸ˆ <small style="font-weight:normal; font-size:0.7rem;">(æ¯æœˆæ”¯æ‰•ãŒä¸€å®š)</small></div>
                <div class="chart-container"><canvas id="chart_ganri"></canvas></div>
            </div>
            <div class="card">
                <div class="section-title">å…ƒé‡‘å‡ç­‰è¿”æ¸ˆ <small style="font-weight:normal; font-size:0.7rem;">(å…ƒé‡‘è¿”æ¸ˆãŒä¸€å®š)</small></div>
                <div class="chart-container"><canvas id="chart_gankin"></canvas></div>
            </div>
        </div>

        <div class="card">
            <div class="section-title">å¹´æ¬¡æ¨ç§»ãƒ»æ®‹å‚µãƒ‡ãƒ¼ã‚¿</div>
            <div class="table-wrapper">
                <table id="data_table">
                    <thead>
                        <tr>
                            <th class="sticky-col">çµŒéå¹´</th>
                            <th>[å…ƒåˆ©] æ”¯æ‰•é¡/å¹´</th>
                            <th>[å…ƒåˆ©] æ§é™¤é¡/å¹´</th>
                            <th style="background:#fff1f2">[å…ƒåˆ©] å€Ÿå…¥æ®‹å‚µ</th>
                            <th>[å…ƒé‡‘] æ”¯æ‰•é¡/å¹´</th>
                            <th>[å…ƒé‡‘] æ§é™¤é¡/å¹´</th>
                            <th style="background:#fff1f2">[å…ƒé‡‘] å€Ÿå…¥æ®‹å‚µ</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
const App = {
    charts: {},

    run() {
        const config = {
            P: parseFloat(document.getElementById('loan_amount').value) * 10000,
            r: (parseFloat(document.getElementById('interest_rate').value) / 100) / 12,
            n: parseInt(document.getElementById('loan_term').value) * 12,
            tLim: parseFloat(document.getElementById('tax_limit').value) * 10000,
            tY: parseInt(document.getElementById('tax_years').value),
            tRate: parseFloat(document.getElementById('tax_rate').value) / 100
        };

        const resGanri = this.calc(config, 'ganri');
        const resGankin = this.calc(config, 'gankin');

        this.renderChart('chart_ganri', resGanri);
        this.renderChart('chart_gankin', resGankin);
        this.renderTable(resGanri, resGankin);

        document.getElementById('result_area').style.display = 'block';
    },

    calc(conf, type) {
        let remaining = conf.P;
        let yearlyData = [];
        const monthlyGanri = conf.P * conf.r * Math.pow(1 + conf.r, conf.n) / (Math.pow(1 + conf.r, conf.n) - 1);
        const fixedPrincipal = conf.P / conf.n;

        for (let y = 1; y <= conf.n / 12; y++) {
            let yPrincipal = 0, yInterest = 0, yTaxBack = 0;
            
            for (let m = 1; m <= 12; m++) {
                let interest = remaining * conf.r;
                let principal = (type === 'ganri') ? (monthlyGanri - interest) : fixedPrincipal;
                yPrincipal += principal;
                yInterest += interest;
                remaining -= principal;
            }

            // å¹´æœ«æ®‹é«˜ã«åŸºã¥ãæ§é™¤è¨ˆç®— (ä¸Šé™è€ƒæ…®)
            if (y <= conf.tY) {
                const base = Math.min(Math.max(0, remaining), conf.tLim);
                yTaxBack = base * conf.tRate;
            }

            yearlyData.push({
                year: y,
                principal: Math.round(yPrincipal / 10000),
                interest: Math.round(yInterest / 10000),
                taxBack: Math.round(yTaxBack / 10000),
                balance: Math.round(Math.max(0, remaining) / 10000)
            });
        }
        return yearlyData;
    },

    renderChart(id, data) {
        const ctx = document.getElementById(id).getContext('2d');
        if (this.charts[id]) this.charts[id].destroy();

        this.charts[id] = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.map(d => d.year + 'å¹´'),
                datasets: [
                    { label: 'å…ƒé‡‘', data: data.map(d => d.principal), backgroundColor: '#3b82f6', stacked: true },
                    { label: 'åˆ©æ¯', data: data.map(d => d.interest), backgroundColor: '#f43f5e', stacked: true },
                    { label: 'æ§é™¤', data: data.map(d => -d.taxBack), backgroundColor: '#16a34a', stacked: true }
                ]
            },
            options: {
                maintainAspectRatio: false,
                scales: {
                    x: { stacked: true },
                    y: { 
                        stacked: true,
                        ticks: { callback: v => Math.abs(v) + 'ä¸‡' },
                        title: { display: true, text: 'å¹´é–“é‡‘é¡ (ä¸‡å††)' }
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: (ctx) => {
                                let label = ctx.dataset.label || '';
                                return label + ': ' + Math.abs(ctx.raw) + 'ä¸‡å††';
                            },
                            afterBody: (items) => {
                                const yearIdx = items[0].dataIndex;
                                return 'å¹´æœ«æ®‹å‚µ: ' + data[yearIdx].balance + 'ä¸‡å††';
                            }
                        }
                    },
                    legend: { display: false }
                }
            }
        });
    },

    renderTable(ganri, gankin) {
        const tbody = document.getElementById('data_table').querySelector('tbody');
        tbody.innerHTML = ganri.map((d, i) => `
            <tr>
                <td class="sticky-col">${d.year}å¹´ç›®</td>
                <td>${(d.principal + d.interest).toLocaleString()}ä¸‡</td>
                <td style="color:var(--color-tax)">-${d.taxBack.toLocaleString()}ä¸‡</td>
                <td style="font-weight:bold">${d.balance.toLocaleString()}ä¸‡</td>
                <td>${(gankin[i].principal + gankin[i].interest).toLocaleString()}ä¸‡</td>
                <td style="color:var(--color-tax)">-${gankin[i].taxBack.toLocaleString()}ä¸‡</td>
                <td style="font-weight:bold">${gankin[i].balance.toLocaleString()}ä¸‡</td>
            </tr>
        `).join('');
    }
};

// åˆæœŸå®Ÿè¡Œ
window.onload = () => App.run();
</script>
</body>
</html>
